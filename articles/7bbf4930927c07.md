---
title: "clag ã‚«ãƒãƒ¬ãƒƒã‚¸"
emoji: "ğŸ“‹ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [C,clang,ã‚«ãƒãƒ¬ãƒƒã‚¸]
published: true
---

clang ã§ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’æ¡å–ã™ã‚‹ã€‚

ã€å‚è€ƒã€‘
https://clang.llvm.org/docs/SourceBasedCodeCoverage.html#source-based-code-coverage

# ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ 

```c:tcov.c
#include <stdio.h>

int add(int data1, int data2)
{
    int result = 0;
    result = data1 + data2;
    return result;
}

int sub(int data1, int data2)
{
    int result = 0;
    result = data1 - data2;
    return result;
}
int cul(int cul, int data1, int data2)
{
    int result = 0;
    if (cul == 1)
    {
        result = add(data1, data2);
    }

    else if (cul == 2)
    {
        result = sub(data1, data2);
    }

    return result;
}

int main()
{
    int add = 0;
    add = cul(1, 10, 8);
    printf("10 + 8 = %d\n", add   );
    return 0;
}
```

# ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã™ã‚‹ã‚ˆã†ã«æŒ‡å®šã™ã‚‹ã€‚

- -fcoverage-mapping
ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æã‚’å¯èƒ½ã«ã™ã‚‹ã€‚

- -fprofile-instr-generate=tcov.profraw
æŒ‡å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã™ã‚‹ã€‚
ã€Œ=tcov.profrawã€ã‚’æŒ‡å®šã—ãªã‘ã‚Œã°ã€Œdefault.profrawã€ã«å‡ºåŠ›ã™ã‚‹ã€‚

```shell-session
~ $ cc -fcoverage-mapping -fprofile-instr-generate=tcov.profraw tcov.c -o tcov
```

ã“ã®æ™‚ç‚¹ã§ã¯å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã€Œtcovã€ãŒç”Ÿæˆã•ã‚Œã‚‹ã ã‘ã§ã‚ã‚‹ã€‚

```shell-session
~ $ ls
tcov*  tcov.c
```

# å®Ÿè¡Œ

```shell-session
~ $ ./tcov
10 + 8 = 18
```

ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’ç¢ºèªã€‚

```shell-session
~ $ ls
tcov*  tcov.c  tcov.profraw
```

ã“ã®æ™‚ã€å…ˆã«æŒ‡å®šã—ãŸã€Œtcov.profrawã€ã«ã‚«ãƒãƒ¬ãƒƒã‚¸çµæœãŒå‡ºåŠ›ã•ã‚Œã‚‹ã€‚

# ã‚«ãƒãƒ¬ãƒƒã‚¸çµæœ

ã€å‚è€ƒã€‘
https://llvm.org/docs/CommandGuide/llvm-profdata.html#llvm-profdata-profile-data-tool

llvm-profdata ãƒ„ãƒ¼ãƒ«ã§ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã™ã‚‹ã€‚

```shell-session
~ $ llvm-profdata merge -sparse tcov.profraw -o tcov.profdata

~ $ ls
tcov*  tcov.c  tcov.profdata  tcov.profraw
```

# ã‚«ãƒãƒ¬ãƒƒã‚¸çµæœè¡¨ç¤º

ã€å‚è€ƒã€‘
https://llvm.org/docs/CommandGuide/llvm-cov.html#llvm-cov-emit-coverage-information

llvm-cov ã§ã‚«ãƒãƒ¬ãƒƒã‚¸çµæœã‚’è¡¨ç¤ºã™ã‚‹ã€‚

```c
~ $ llvm-cov show /data/data/com.termux/files/usr/bin/_local/tcov -instr-profile=tcov.profdata
    1|     |#include <stdio.h>
    2|     |
    3|     |int add(int data1, int data2)
    4|    1|{
    5|    1|  int result = 0;
    6|    1|  result = data1 + data2;
    7|    1|  return result;
    8|    1|}
    9|     |
   10|     |int sub(int data1, int data2)
   11|    0|{
   12|    0|  int result = 0;
   13|    0|  result = data1 - data2;
   14|    0|  return result;
   15|    0|}
   16|     |
   17|     |int cul(int cul, int data1, int data2)
   18|    1|{
   19|    1|  int result = 0;
   20|    1|  if (cul == 1)
   21|    1|  {
   22|    1|      result = add(data1, data2);
   23|    1|  }
   24|     |
   25|    0|  else if (cul == 2)
   26|    0|  {
   27|    0|      result = sub(data1, data2);
   28|    0|  }
   29|     |
   30|    1|  return result;
   31|    1|}
   32|     |
   33|     |int main()
   34|    1|{
   35|    1|  int add = 0;
   36|    1|  add = cul(1, 10, 8);
   37|    1|  printf("10 + 8 = %d\n", add   );
   38|    1|  return 0;
   39|    1|}
   40|     |

~ $
```

